<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">

    <title>YAB - Let's Encrypt Auto-Renewal with Haproxy</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1><a href="/" class="a-hover">YAB - Yet Another Blog</a></h1>
        <h2>/ Let's Encrypt Auto-Renewal with Haproxy</h2>

        <section id="downloads">
          <a href="https://github.com/ibizaman" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
          <p>I want to serve a website or an API over https. That should
              not be that complicated, right?</p>
          <p>The good news is that if you do not want to handle the
              https' SSL handshake, you do not need to! We will use
              Haproxy to do all the heavy lifting.</p>
          <p>Haproxy will handle all the https SSL handshake and forward
              the requests to an internal web server using plain http.
              The SSL certificates will be automatically retrieved
              thanks to let's encrypt and will be automatically renewed
              with a cron job.</p>
          <p>After the initial setup, adding another website will be
              pretty much straightforward.<p>
          <p>Let's get started!</p>

          <h2>Setup a Domain</h2>
          <p>First let's make the server accessible through a domain.</p>
          <p>For that, go to <a href="https://www.godaddy.com">Godaddy</a>,
              buy your dream domain name and make it point to your
              server's external IP address by adding a A record:</p>
          <pre>Type  Name  Value          TTL<br>A     @     167.32.23.254  600 seconds</pre>
          <p><span class="code">167.32.23.254</span> is an example
              external IP address. To know yours, the simplest is to
              query the amazingly <i>free</i> service
              <a href="https://www.ipify.org/">ipify.org</a>. Just issue, on the server:</p>
          <pre>curl 'https://api.ipify.org'</pre>
          <p>That will return you current external IP address.</p>

          <h3>Dynamic IP Address</h3>
          <p>In my case, it does not end there. In fact my server has
              a dynamic external IP. So I need something monitoring
              changes in my external IP and updating the Godaddy
              A record. For that, I simply use the script
              <a href="https://github.com/AndreasLoow/godaddy-dyndns">godaddy-dyndns</a>.
              Follow the link to get some very easy installation
              instructions. You will see that the script uses ipify.org
              too. :)</p>
          <p>The only difference in what I did with the instructions in
              the link is that I use
              <a href="http://fcron.free.fr/doc/en/fcrontab.5.html">fcrontab</a>,
              instead of crontab. It is installed with:</p>
          <pre>sudo pacman -S fcrontab</pre>

          <h2>Setup haproxy</h2>
          <p>First, we will install haproxy</p>
          <pre>sudo pacman -S community/haproxy</pre>
          <p>And the haproxy plugin with:</p>
          <pre>sudo mkdir -p /etc/haproxy/plugins/haproxy-acme-validation-plugin-0.1.1
sudo curl -o /etc/haproxy/plugins/haproxy-acme-validation-plugin-0.1.1/acme-http01-webroot.lua \
    https://raw.githubusercontent.com/janeczku/haproxy-acme-validation-plugin/master/acme-http01-webroot.lua</pre>
          <p>The configuration file of haproxy is
              <span class="code">/etc/haproxy/haproxy.cfg</span>.
              If you meet haproxy for the first time, I would advice
              using the
              <span class="code">/etc/haproxy/haproxy.cfg.sample</span>
              file as a basis. From it, you can add the two global lines
              hereunder and remove all frontend and backend sections and
              replace them with what is following.</p>
          <p>In any case, I used and changed a bit the configuration from
              <a href="https://blog.brixit.nl/automating-letsencrypt-and-haproxy">this blog post</a>.
              Thanks martijn for doing all the hard work!</p>
          <pre>global
    <span class="comment"># Load the plugin handling Let's Encrypt request</span>
    lua-load /etc/haproxy/plugins/haproxy-acme-validation-plugin-0.1.1/acme-http01-webroot.lua
    <span class="comment"># Silence a warning issued by haproxy. Using 2048</span>
    <span class="comment"># instead of the default 1024 makes the connection stronger.</span>
    tune.ssl.default-dh-param  2048

frontend  http
    <span class="comment"># Listen on the port 80 for incoming requests, without restriction on incoming ips</span>
    bind *:80

    <span class="comment"># Matches all requests where the path is /.well-known/acme-challenge/</span>
    <span class="comment"># This match can be referred to using the name url_acme_http01 for the rest of the configuration</span>
    acl url_acme_http01  path_beg       /.well-known/acme-challenge/
    <span class="comment"># All GET requests matching the acl above be handled by the plugin</span>
    http-request use-service lua.acme-http01 if METH_GET url_acme_http01</pre>
          <p>If you don't use <span class="code">chroot</span> option
              under the global group, you will need to modify the plugin
              slightly. For a default haproxy install on archlinux, edit
              the plugin and set:</p>
          <pre>acme.conf = {
        ["non_chroot_webroot"] = "/usr/share/haproxy"
}</pre>
          <p>Now we reload haproxy to make it handle the new
              configuration:</p>
          <pre>systemctl reload haproxy</pre>

          <h2>Setup the Certification Bot</h2>
          <p>Installing the Let's Encrypt certification bot is done
              with:</p>
          <pre>sudo pacman -S community/certbot</pre>
          <p>Like said before, the certificate renewal will be automated
              using a cron job, so let's install <a href="http://fcron.free.fr/doc/en/fcrontab.5.html">fcron</a>:</p>
          <pre>sudo pacman -S community/fcron</pre>
          <p>fcron has nice features compared to the plain old crontab
              like handling asynchronous jobs and running jobs
              manually. We will need the latter shortly.</p>
              
          <p>Again, the script used to renew the certificates is
              shamelessly adapted from
              <a href="https://blog.brixit.nl/automating-letsencrypt-and-haproxy">martijn's blog</a>.
              I installed it in
              <span class="code">/usr/local/bin/haproxy-ssl-renew</span>:</p>
          <pre>#!/bin/bash

<span class="comment"># Stop the whole script on first error</span>
set -e

<span class="comment"># Path to the letsencrypt-auto tool</span>
LE_TOOL=/usr/bin/certbot

<span class="comment"># Directory where the acme client puts the generated certs</span>
LE_OUTPUT=/etc/letsencrypt/live

<span class="comment"># Directory where the certificates will be stored for haproxy to find them</span>
DEST_DIR="/etc/ssl/my_cert/"

<span class="comment"># Concat the requested domains</span>
DOMAINS=""
for DOM in "$@"
do
    DOMAINS+=" -d $DOM"
done

<span class="comment"># Create or renew certificate for the domain(s) supplied for this tool</span>
<span class="comment"># The parenthesis make the script run in a subshell, this is needed so it doesn't mangle $@</span>
($LE_TOOL certonly --text --agree-tos --renew-by-default --webroot --webroot-path /usr/share/haproxy $DOMAINS)

<span class="comment"># Merge and copy the certificates to the destination directory</span>
for DOM in "$@"
do
    cat $LE_OUTPUT/$DOM/fullchain.pem $LE_OUTPUT/$DOM/privkey.pem > $DEST_DIR/$DOM.pem
done

<span class="comment"># Reload the haproxy daemon to fetch the new certificates</span>
systemctl reload haproxy</pre>
          <p>We can then put this in fcron:</p>
          <pre>sudo fcrontab -e<br>10 4 1 */3 * /usr/local/bin/haproxy-ssl-renew mydream.com</pre>
          <p>Of course, replace <span class="code">mydream.com</span>
              with your domain. With this line, the script will run
              every three month, on the first day of the month, at
              4:10am. You can of course change this to your liking but
              remember that the certificate will only be valid for four
              months.</p> 
          <p>But we won't wait that long to get our first certificate!
              We will run the script right now:</p>
          <pre>sudo fcrondyn
<span class="comment"># Show all scripts</span>
ls
<span class="comment"># Locate the script we just added, for example:</span>
36 |root |2016-10-01 04:12|/usr/local/bin/plex-ssl-renew mydream.com
<span class="comment"># run it:</span>
runnow 36
</pre>
          
          <h3>Make Haproxy Use the New Certificates</h3>
          <p>The last step, we are nearly there!</p>
          <p>The following example is a bit more involved than needed if
              you just want to serve a unique web server, but it shows
              a neat feature if you have multiple subdomains. In that
              case, you can let haproxy find the SSL certificate
              corresponding to the subdomain instead of specifying that
              manually.</p>
          <p>Say you have two subdomains web1 and web2. You will first need to enable them in Godaddy by adding a CNAME:</p>
          <pre>Type   Name  Value  TTL<br>CNAME  web1  @      600 seconds<br>CNAME  web2  @      600 seconds</pre>
          <p>Then add the following to the existing haproxy.cfg file:</p>
          <pre>frontend https
    <span class="comment"># Listen on port 443, the default https port and fetch the</span>
    <span class="comment"># certificates inside the /etc/ssl/my_cert directory</span>
    bind *:443 ssl crt /etc/ssl/my_cert/

    <span class="comment"># Match requests on the webX subdomain.</span>
    acl web1   hdr(host) -i web1.mydream.com
    acl web2   hdr(host) -i web2.mydream.com

    <span class="comment"># Forward requests for subdomain webX to backend named webX.</span>
    use_backend web1 if web1
    use_backend web2 if web2
    <span class="comment"># Forward any other requests to backend named webZ.</span>
    default_backend webZ

backend web1
    <span class="comment"># Any requests coming to backend web1 will be forwarded to port 8080.</span>
    server web1 127.0.0.1:8080

backend web2
    server web2 127.0.0.1:8081

backend webZ
    server webZ 127.0.0.1:8082</pre>
          <p>Again, we reload haproxy:</p>
          <pre>systemctl reload haproxy</pre>
          <p>Finally, we need to tweak the fcron line to include all subdomains:</p>
          <pre>sudo fcrontab -e
10 4 1 */3 * /usr/local/bin/haproxy-ssl-renew mydream.com web1.mydream.com web2.mydream.com</pre>
          <h2>Success!</h2>
          <p>We did it! We can now access our websites through
              <a href="https://mydream.com">https://mydream.com</a>,
              <a href="https://web1.mydream.com">https://web1.mydream.com</a>
              and <a href="https://web2.mydream.com">https://web2.mydream.com</a>.
              Notice that your browser accepts the certificate and you
              get a nice green address bar!</p>
      </section>
    </div>

    <footer>
      <div class="container">
          <p>Thanks for reading through, I hope this blog post was
              helpful to you. Got any issue? Don't hesitate to open an
              issue on GitHub.<br> - ibizaman</p>
      </div>
    </footer>
    
  </body>
</html>
